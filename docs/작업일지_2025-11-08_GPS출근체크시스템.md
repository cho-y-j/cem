# 작업 일지 - GPS 기반 출근 체크 시스템 완성

**작업일**: 2025-11-08
**작업자**: Claude Code Assistant
**소요 시간**: 약 4시간
**Git Commit**: (커밋 후 추가 예정)

---

## 📋 목차
1. [작업 개요](#작업-개요)
2. [구현된 기능](#구현된-기능)
3. [파일 변경 내역](#파일-변경-내역)
4. [데이터베이스 스키마](#데이터베이스-스키마)
5. [API 엔드포인트](#api-엔드포인트)
6. [테스트 가이드](#테스트-가이드)
7. [다음 단계](#다음-단계)
8. [기술 노트](#기술-노트)

---

## 작업 개요

### 배경
사용자가 요청한 GPS 기반 출근 체크 시스템을 구현했습니다. 이 시스템은 Worker가 작업 현장에 도착했을 때 GPS를 통해 위치를 확인하고, 미리 설정된 작업 구역 내에 있는지 검증하는 기능입니다.

### 주요 목표
1. **작업 구역 관리**: EP/Admin이 Google Maps를 사용하여 작업 구역을 정의
2. **GPS 출근 체크**: Worker가 모바일에서 GPS로 현재 위치를 전송하고 출근 기록
3. **관리자 대시보드**: Admin/EP/Owner가 출근 현황을 실시간으로 모니터링
4. **엑셀 다운로드**: 출근 기록을 Excel 파일로 다운로드
5. **WebAuthn 준비**: 향후 생체 인증을 위한 기본 구조 마련

### 핵심 개념
- **출근 (Check-in)**: 작업 현장 도착 시각 기록 (1일 1회)
- **작업 시작 (Work Session)**: 실제 장비 운전 시작/종료 (여러 번 가능)
- **작업 구역 (Work Zone)**: GPS 중심점 + 반경으로 정의된 허용 구역
- **구역 내/외 판정**: Haversine 공식으로 거리 계산하여 자동 판정

---

## 구현된 기능

### 1. 작업 구역 관리 (Work Zones) ✅

**위치**: `/work-zones`
**접근 권한**: EP, Admin

#### 기능
- ✅ Google Maps 통합 (@vis.gl/react-google-maps)
- ✅ 드래그 가능한 마커로 중심점 설정
- ✅ 반경 조정 슬라이더 (10m ~ 1000m)
- ✅ 원(Circle) 시각화로 작업 구역 표시
- ✅ 작업 구역 CRUD (생성/읽기/수정/삭제)
- ✅ 작업 구역 정보: 이름, 설명, 중심 좌표, 반경

#### 구현 상세
```typescript
// 작업 구역 데이터 구조
interface WorkZone {
  id: string;
  name: string;
  description?: string;
  centerLat: string;     // 중심 위도 (decimal)
  centerLng: string;     // 중심 경도 (decimal)
  radiusMeters: number;  // 반경 (미터)
  isActive: boolean;     // 활성 상태
}
```

**UI 특징**:
- 마커 드래그 시 좌표 실시간 업데이트
- 반경 슬라이더로 원 크기 실시간 변경
- 빠른 설정 버튼: 50m, 100m, 200m, 500m

---

### 2. 출근 체크 API ✅

**파일**: `server/check-in-router.ts`

#### 주요 엔드포인트

##### 2.1 출근하기 (`checkIn.create`)
```typescript
// Input
{
  workZoneId?: string,  // 선택적 (없으면 deployment에서 자동 조회)
  lat: number,          // 현재 위도
  lng: number,          // 현재 경도
  authMethod: "pin" | "password" | "webauthn",
  notes?: string
}

// Output
{
  id: string,
  checkInTime: Date,
  isWithinZone: boolean,        // 구역 내 여부
  distanceFromZone: number,     // 구역 중심으로부터 거리 (m)
  ...
}
```

**동작 과정**:
1. Worker 정보 조회 (`workers` 테이블)
2. 활성 Deployment 조회 → 작업 구역 ID 획득
3. GPS 거리 계산 (Haversine 공식)
4. 구역 내/외 판정 (`distance <= radiusMeters`)
5. `check_ins` 테이블에 저장
6. 클라이언트에 결과 반환

**중요**: 구역 밖에서 출근해도 **차단하지 않고** 경고만 표시합니다. 관리자가 나중에 확인할 수 있도록 `isWithinZone=false`로 기록됩니다.

##### 2.2 오늘 출근 상태 (`checkIn.getTodayStatus`)
```typescript
// Output
{
  hasCheckedIn: boolean,
  checkIn: CheckIn | null
}
```

Worker가 오늘 이미 출근했는지 확인합니다. UI에서 "출근하기" 버튼 표시 여부를 결정하는 데 사용됩니다.

##### 2.3 오늘 출근 통계 (`checkIn.getTodayStats`)
**권한**: Admin, EP, Owner

```typescript
// Output
{
  total: number,            // 총 출근자
  withinZone: number,       // 구역 내 출근
  outsideZone: number,      // 구역 외 출근
  withWebauthn: number,     // 생체 인증 출근
  morning: number,          // 오전 출근 (00:00~11:59)
  afternoon: number,        // 오후 출근 (12:00~23:59)
  checkIns: CheckIn[]       // 전체 기록 (Worker 이름 포함)
}
```

---

### 3. GPS 거리 계산 (Haversine 공식) ✅

**파일**: `server/db.ts`

```typescript
export function calculateDistance(
  lat1: number, lng1: number,
  lat2: number, lng2: number
): number {
  const R = 6371e3; // 지구 반지름 (미터)
  const φ1 = (lat1 * Math.PI) / 180;
  const φ2 = (lat2 * Math.PI) / 180;
  const Δφ = ((lat2 - lat1) * Math.PI) / 180;
  const Δλ = ((lng2 - lng1) * Math.PI) / 180;

  const a =
    Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
    Math.cos(φ1) * Math.cos(φ2) *
    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

  return R * c; // 거리 (미터)
}
```

**정확도**:
- 오차 범위: ±0.5% (실제 거리의 0.5% 이내)
- 예: 100m 거리라면 ±0.5m 오차

---

### 4. Worker 모바일 출근 UI ✅

**파일**: `client/src/pages/mobile/WorkerMain.tsx`
**경로**: `/mobile/worker`

#### UI 상태

##### 미출근 상태
```
┌─────────────────────────────────┐
│  오늘 아직 출근하지 않았습니다    │
│                                 │
│  ┌──────────────────────────┐  │
│  │   ✓ 출근하기              │  │
│  └──────────────────────────┘  │
│                                 │
│  📍 현재 위치가 자동으로 기록됩니다│
└─────────────────────────────────┘
(인디고 배경)
```

##### 출근 완료 상태
```
┌─────────────────────────────────┐
│  ✓ 출근 완료                     │
│  09:15                          │
│  ✓ 작업 구역 내 (120m)          │
└─────────────────────────────────┘
(녹색 배경)
```

##### 구역 외 출근 상태
```
┌─────────────────────────────────┐
│  ✓ 출근 완료                     │
│  09:20                          │
│  ⚠ 작업 구역 밖 (350m)          │
└─────────────────────────────────┘
(주황색 경고)
```

#### 출근 프로세스

1. **"출근하기" 버튼 클릭**
   - Toast: "GPS 위치를 확인하는 중..."

2. **GPS 권한 요청**
   - 브라우저 위치 권한 팝업 표시
   - 사용자가 "허용" 선택

3. **GPS 좌표 획득**
   ```javascript
   navigator.geolocation.getCurrentPosition(
     (position) => {
       const { latitude, longitude } = position.coords;
       // API 호출
     },
     (error) => {
       toast.error("위치 정보를 가져올 수 없습니다");
     },
     {
       enableHighAccuracy: true,  // 고정밀도
       timeout: 10000,            // 10초 타임아웃
       maximumAge: 0              // 캐시 사용 안 함
     }
   );
   ```

4. **API 호출 및 결과 표시**
   - 성공: "출근이 완료되었습니다! 작업 구역 내에서 출근하셨습니다 (XXXm)"
   - 경고: "출근이 완료되었습니다! 작업 구역 밖에서 출근하셨습니다 (XXXm 떨어짐)"
   - 실패: "위치 정보를 가져올 수 없습니다. GPS를 활성화해주세요."

5. **화면 업데이트**
   - 인디고 배너 → 녹색/주황색 카드로 변경
   - 출근 시간 표시
   - 구역 내/외 정보 표시

---

### 5. 관리자 출근 현황 대시보드 ✅

**파일**: `client/src/pages/CheckInMonitoring.tsx`
**경로**: `/check-in-monitoring`
**접근 권한**: Admin, EP, Owner, BP

#### 통계 카드

```
┌──────────────┬──────────────┬──────────────┬──────────────┐
│ 총 출근자    │ 구역 내 출근 │ 구역 외 출근 │ 생체 인증    │
│   15명       │   12명 (80%) │   3명 (20%)  │   0명        │
│ Users 아이콘 │ ✓ 녹색       │ ⚠ 주황색     │ 🔐 파란색   │
└──────────────┴──────────────┴──────────────┴──────────────┘
```

#### 시간대별 분포
- 오전 (00:00 ~ 11:59): X명
- 오후 (12:00 ~ 23:59): Y명

#### 출근 기록 목록

```
┌────────────────────────────────────────────────┐
│ 👤 김철수                                      │
│ 09:15  📍 강남 건설 현장 (120m)                │
│ ✓ 구역 내                                      │
└────────────────────────────────────────────────┘

┌────────────────────────────────────────────────┐
│ 👤 이영희                                      │
│ 09:20  📍 서초 프로젝트 (350m)                 │
│ ⚠ 구역 외                                      │
└────────────────────────────────────────────────┘
```

#### 기능
- ✅ 날짜 필터: 특정 날짜의 출근 기록 조회
- ✅ 검색: 작업자 이름, 작업 구역 이름으로 검색
- ✅ 새로고침: 최신 데이터 조회
- ✅ 엑셀 다운로드: 출근 기록을 Excel 파일로 저장

---

### 6. Worker 정보 JOIN ✅

**수정 파일**: `server/db.ts` - `getCheckIns()` 함수

**변경 전**:
```typescript
let query = supabase.from('check_ins').select('*');
```

**변경 후**:
```typescript
let query = supabase.from('check_ins').select(`
  *,
  user:users!check_ins_user_id_fkey(id, name, email, role),
  worker:workers!check_ins_worker_id_fkey(id, user_id),
  work_zone:work_zones!check_ins_work_zone_id_fkey(id, name)
`);
```

**효과**:
- 출근 목록에 작업자 이름 표시 (`checkIn.user.name`)
- 작업 구역 이름 표시 (`checkIn.workZone.name`)
- 검색 기능 구현 가능

---

### 7. 엑셀 다운로드 기능 ✅

**라이브러리**: `xlsx` (v0.18.5)

#### API 엔드포인트
```typescript
checkIn.exportToExcel.query({
  startDate?: string,
  endDate?: string
})
```

#### 엑셀 컬럼
1. 출근일시
2. 작업자
3. 이메일
4. 작업구역
5. 구역내출근 (O/X)
6. 거리(m)
7. 인증방법
8. 생체인증 (O/X)
9. 위도
10. 경도

#### 파일명 형식
`출근기록_YYYY-MM-DD.xlsx`

#### 구현 흐름
1. **서버**: 출근 기록 조회 → JSON → Excel Buffer → Base64 인코딩
2. **클라이언트**: Base64 디코딩 → Blob 생성 → 다운로드 링크 트리거

```typescript
// 서버 (check-in-router.ts)
const excelBuffer = XLSX.write(workbook, {
  type: 'buffer',
  bookType: 'xlsx'
});
return {
  data: excelBuffer.toString('base64'),
  filename: `출근기록_${new Date().toISOString().split('T')[0]}.xlsx`
};

// 클라이언트 (CheckInMonitoring.tsx)
const byteCharacters = atob(result.data);
const byteArray = new Uint8Array(byteCharacters.length);
for (let i = 0; i < byteCharacters.length; i++) {
  byteArray[i] = byteCharacters.charCodeAt(i);
}
const blob = new Blob([byteArray], {
  type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
});
const url = window.URL.createObjectURL(blob);
const link = document.createElement('a');
link.download = result.filename;
link.click();
```

---

### 8. WebAuthn 기본 구조 ✅

**파일**: `server/webauthn-router.ts`

#### 준비된 API (실제 구현은 향후 진행)

1. **등록 챌린지 생성** (`webauthn.generateRegistrationChallenge`)
   - WebAuthn 등록 프로세스 시작
   - 난수 생성 및 반환

2. **크레덴셜 등록** (`webauthn.registerCredential`)
   - 공개키 저장
   - `webauthn_credentials` 테이블에 저장

3. **인증 챌린지 생성** (`webauthn.generateAuthenticationChallenge`)
   - 로그인 시 챌린지 생성

4. **인증 검증** (`webauthn.verifyAuthentication`)
   - 서명 검증
   - 카운터 업데이트

5. **내 크레덴셜 목록** (`webauthn.myCredentials`)
   - 등록된 기기 목록 조회

6. **크레덴셜 삭제** (`webauthn.deleteCredential`)
   - 기기 제거

**향후 작업**:
- `@simplewebauthn/server` 및 `@simplewebauthn/browser` 라이브러리 사용
- 실제 공개키 암호화 구현
- 지문/얼굴 인식과 통합

---

## 파일 변경 내역

### 신규 파일 (8개)

1. **`server/work-zone-router.ts`** (110 lines)
   - 작업 구역 관리 API
   - CRUD 엔드포인트

2. **`server/check-in-router.ts`** (328 lines)
   - 출근 체크 API
   - 엑셀 다운로드 기능 포함

3. **`server/webauthn-router.ts`** (175 lines)
   - WebAuthn API 스텁
   - 생체 인증 준비

4. **`client/src/pages/WorkZones.tsx`** (391 lines)
   - Google Maps 작업 구역 관리 UI
   - 드래그 가능한 마커

5. **`client/src/pages/CheckInMonitoring.tsx`** (281 lines)
   - 출근 현황 대시보드
   - 통계 카드, 검색, 엑셀 다운로드

6. **`docs/check-in-system-test-checklist.md`** (900+ lines)
   - 완전한 테스트 체크리스트
   - 100개 이상 테스트 항목

7. **`docs/작업일지_2025-11-08_GPS출근체크시스템.md`** (이 파일)
   - 상세 작업 기록

8. **`todos.md`** (업데이트 예정)
   - 전체 프로젝트 TODO 목록

### 수정 파일 (7개)

1. **`drizzle/schema.ts`**
   - `work_zones` 테이블 추가
   - `check_ins` 테이블 추가
   - `webauthn_credentials` 테이블 추가

2. **`server/db.ts`**
   - `calculateDistance()` 함수 추가 (Haversine)
   - `isWithinWorkZone()` 함수 추가
   - Work Zone CRUD 함수 추가
   - Check-in CRUD 함수 추가
   - `getCheckIns()` 함수에 JOIN 추가

3. **`server/routers.ts`**
   - `workZones: workZoneRouter` 등록
   - `checkIn: checkInRouter` 등록
   - `webauthn: webauthnRouter` 등록

4. **`client/src/pages/mobile/WorkerMain.tsx`**
   - 출근 체크 섹션 추가 (미출근/출근완료 상태)
   - GPS 권한 요청 및 처리
   - `checkIn.getTodayStatus` 쿼리 추가
   - `checkIn.create` 뮤테이션 추가

5. **`client/src/App.tsx`**
   - `/work-zones` 라우트 추가
   - `/check-in-monitoring` 라우트 추가

6. **`client/src/components/DashboardLayout.tsx`**
   - "작업 구역 관리" 메뉴 추가 (EP/Admin)
   - "출근 현황" 메뉴 추가 (Owner/EP/BP/Admin)

7. **`package.json`** (via `pnpm add xlsx`)
   - `xlsx: 0.18.5` 의존성 추가

---

## 데이터베이스 스키마

### 1. `work_zones` 테이블

```sql
CREATE TABLE work_zones (
  id VARCHAR(64) PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  center_lat DECIMAL(10, 8) NOT NULL,  -- 예: 37.56652345
  center_lng DECIMAL(11, 8) NOT NULL,  -- 예: 126.97803456
  radius_meters INTEGER NOT NULL DEFAULT 100,
  company_id VARCHAR(64),
  created_by VARCHAR(64),
  is_active BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  deleted_at TIMESTAMPTZ
);
```

**인덱스 권장**:
```sql
CREATE INDEX idx_work_zones_active ON work_zones(is_active) WHERE deleted_at IS NULL;
CREATE INDEX idx_work_zones_company ON work_zones(company_id);
```

### 2. `check_ins` 테이블

```sql
CREATE TABLE check_ins (
  id VARCHAR(64) PRIMARY KEY,
  worker_id VARCHAR(64) NOT NULL,
  user_id VARCHAR(64) NOT NULL,
  deployment_id VARCHAR(64),
  work_zone_id VARCHAR(64),

  check_in_time TIMESTAMPTZ NOT NULL,
  check_in_lat DECIMAL(10, 8),
  check_in_lng DECIMAL(11, 8),

  distance_from_zone INTEGER,     -- 거리 (미터)
  is_within_zone BOOLEAN DEFAULT false,

  auth_method VARCHAR(50),        -- 'pin', 'password', 'webauthn'
  webauthn_verified BOOLEAN DEFAULT false,
  webauthn_credential_id VARCHAR(255),

  device_info TEXT,
  notes TEXT,

  created_at TIMESTAMPTZ DEFAULT NOW(),

  FOREIGN KEY (worker_id) REFERENCES workers(id),
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (deployment_id) REFERENCES deployments(id),
  FOREIGN KEY (work_zone_id) REFERENCES work_zones(id)
);
```

**인덱스 권장**:
```sql
CREATE INDEX idx_check_ins_user_date ON check_ins(user_id, check_in_time DESC);
CREATE INDEX idx_check_ins_worker ON check_ins(worker_id);
CREATE INDEX idx_check_ins_zone ON check_ins(work_zone_id);
CREATE INDEX idx_check_ins_date ON check_ins(check_in_time DESC);
```

**중요 쿼리 최적화**:
```sql
-- 오늘 출근 여부 조회 (자주 사용됨)
SELECT * FROM check_ins
WHERE user_id = $1
  AND check_in_time >= CURRENT_DATE
  AND check_in_time < CURRENT_DATE + INTERVAL '1 day'
ORDER BY check_in_time DESC
LIMIT 1;
```

### 3. `webauthn_credentials` 테이블

```sql
CREATE TABLE webauthn_credentials (
  id VARCHAR(255) PRIMARY KEY,    -- credentialId (Base64)
  user_id VARCHAR(64) NOT NULL,
  public_key TEXT NOT NULL,       -- 공개키 (Base64)
  counter INTEGER NOT NULL DEFAULT 0,
  device_name VARCHAR(255),       -- 예: "iPhone 13 Pro"
  device_type VARCHAR(50),        -- 'platform' or 'cross-platform'
  created_at TIMESTAMPTZ DEFAULT NOW(),
  last_used_at TIMESTAMPTZ,

  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

**인덱스**:
```sql
CREATE INDEX idx_webauthn_user ON webauthn_credentials(user_id);
```

---

## API 엔드포인트

### Work Zones API

```typescript
// 작업 구역 생성 (EP/Admin만)
trpc.workZones.create.mutate({
  name: string,
  description?: string,
  centerLat: number,
  centerLng: number,
  radiusMeters: number
})

// 작업 구역 목록 조회
trpc.workZones.list.useQuery()

// 작업 구역 수정
trpc.workZones.update.mutate({
  id: string,
  ...updateData
})

// 작업 구역 삭제 (Soft Delete)
trpc.workZones.delete.mutate({ id: string })

// 현재 위치가 작업 구역 내인지 확인
trpc.workZones.checkLocation.useQuery({
  workZoneId: string,
  lat: number,
  lng: number
})
```

### Check-In API

```typescript
// 출근하기
trpc.checkIn.create.mutate({
  workZoneId?: string,
  lat: number,
  lng: number,
  authMethod: "pin" | "password" | "webauthn",
  webauthnCredentialId?: string,
  notes?: string
})

// 오늘 출근 상태 조회
trpc.checkIn.getTodayStatus.useQuery()

// 내 출근 기록 조회
trpc.checkIn.myList.useQuery({
  startDate?: string,
  endDate?: string,
  limit?: number
})

// 전체 출근 기록 조회 (Admin/EP/Owner)
trpc.checkIn.list.useQuery({
  workerId?: string,
  workZoneId?: string,
  startDate?: string,
  endDate?: string,
  limit?: number
})

// 오늘 출근 통계 (Admin/EP/Owner)
trpc.checkIn.getTodayStats.useQuery()

// 특정 Worker의 출근 기록 (Admin/EP/Owner)
trpc.checkIn.getByWorkerId.useQuery({
  workerId: string,
  startDate?: string,
  endDate?: string
})

// 엑셀 다운로드 (Admin/EP/Owner)
trpc.checkIn.exportToExcel.query({
  startDate?: string,
  endDate?: string
})
```

### WebAuthn API (준비 단계)

```typescript
// 등록 챌린지 생성
trpc.webauthn.generateRegistrationChallenge.useQuery()

// 크레덴셜 등록
trpc.webauthn.registerCredential.mutate({
  credentialId: string,
  publicKey: string,
  deviceName?: string
})

// 인증 챌린지 생성
trpc.webauthn.generateAuthenticationChallenge.useQuery()

// 인증 검증
trpc.webauthn.verifyAuthentication.mutate({
  credentialId: string,
  signature: string,
  authenticatorData: string,
  clientDataJSON: string
})

// 내 크레덴셜 목록
trpc.webauthn.myCredentials.useQuery()

// 크레덴셜 삭제
trpc.webauthn.deleteCredential.mutate({ credentialId: string })
```

---

## 테스트 가이드

### 테스트 준비

1. **데이터베이스 테이블 확인**
   ```sql
   SELECT table_name FROM information_schema.tables
   WHERE table_schema = 'public'
   AND table_name IN ('work_zones', 'check_ins', 'webauthn_credentials');
   ```

2. **개발 서버 실행**
   ```bash
   pnpm dev
   # http://localhost:3001/ 접속
   ```

3. **테스트 계정 준비**
   - Admin: admin@test.com / test123
   - EP: ep@test.com / test123
   - Worker: PIN 1234 (모바일 로그인)

### 테스트 시나리오

#### 시나리오 1: 작업 구역 생성

1. EP 계정으로 로그인
2. 좌측 메뉴 → "작업 구역 관리"
3. "새 작업 구역" 버튼 클릭
4. 정보 입력:
   - 이름: "강남 건설 현장"
   - 설명: "테헤란로 오피스 건설"
   - 마커를 원하는 위치로 드래그
   - 반경: 200m
5. "생성" 버튼 클릭
6. 작업 구역 카드가 목록에 추가되었는지 확인

#### 시나리오 2: Worker 출근 (구역 내)

**조건**: Worker가 작업 구역 반경 내에 있어야 함 (테스트 환경에서는 Mock GPS 사용 가능)

1. 모바일 로그인: `/mobile/login`
2. PIN 1234 입력
3. "출근하기" 버튼 클릭
4. GPS 권한 허용
5. 성공 메시지 확인:
   - "출근이 완료되었습니다!"
   - "작업 구역 내에서 출근하셨습니다 (120m)"
6. 녹색 "출근 완료" 카드 확인

#### 시나리오 3: 관리자 출근 현황 확인

1. Admin 계정으로 로그인
2. 좌측 메뉴 → "출근 현황"
3. 통계 카드 확인:
   - 총 출근자: 1명
   - 구역 내 출근: 1명 (100%)
4. 출근 기록 목록에서 Worker 이름, 시간, 구역 정보 확인
5. "엑셀 다운로드" 버튼 클릭
6. `출근기록_YYYY-MM-DD.xlsx` 파일 다운로드 확인

#### 시나리오 4: 구역 외 출근 경고

1. Worker가 작업 구역에서 멀리 떨어진 곳에서 출근 시도
2. 성공 메시지 확인:
   - "출근이 완료되었습니다!"
   - "작업 구역 밖에서 출근하셨습니다 (350m 떨어짐)"
3. 주황색 경고 카드 확인
4. Admin 대시보드에서 "구역 외 출근" 통계 증가 확인

#### 시나리오 5: 중복 출근 방지

1. Worker가 오전에 이미 출근함
2. 오후에 다시 "출근하기" 시도
3. 에러 메시지 확인:
   - "이미 오늘 출근하셨습니다. (09:15)"
4. 출근 완료 카드 유지

---

### Mock GPS 테스트 (개발 환경)

실제 GPS가 없는 데스크탑에서 테스트하려면:

```javascript
// 브라우저 개발자 도구 Console에서 실행
// Geolocation API Mock
navigator.geolocation.getCurrentPosition = function(success) {
  success({
    coords: {
      latitude: 37.56652, // 작업 구역 중심 좌표
      longitude: 126.97803,
      accuracy: 10
    },
    timestamp: Date.now()
  });
};
```

---

## 다음 단계

### 1. WebAuthn 실제 구현 (우선순위: 높음)

**예상 시간**: 2-3일

**작업 내용**:
1. 라이브러리 설치
   ```bash
   pnpm add @simplewebauthn/server @simplewebauthn/browser
   ```

2. Registration Flow 구현
   - Challenge 생성 및 임시 저장
   - 공개키 검증 및 저장
   - 프론트엔드 등록 UI

3. Authentication Flow 구현
   - 지문/얼굴 인식으로 출근 체크
   - 서명 검증
   - WebAuthn 인증 성공 시 `webauthnVerified=true` 기록

4. 설정 페이지
   - `/mobile/profile`에 "생체 인증 설정" 추가
   - 등록된 기기 목록 표시
   - 기기 추가/삭제 기능

### 2. 작업 구역 자동 할당 (우선순위: 중간)

**예상 시간**: 1일

**작업 내용**:
- Deployment 생성 시 `work_zone_id` 필드 추가
- BP사별 기본 작업 구역 설정 기능
- Worker 출근 시 Deployment의 `work_zone_id` 자동 사용

### 3. 출근 알림 시스템 (우선순위: 중간)

**예상 시간**: 2일

**작업 내용**:
- 출근 완료 시 Admin/EP에게 알림
- 구역 외 출근 시 경고 알림
- 늦은 출근 자동 감지 (예: 9시 이후 출근 시)
- 이메일 또는 푸시 알림 연동

### 4. 데이터 정합성 강화 (우선순위: 높음)

**예상 시간**: 1일

**작업 내용**:
- 1 Worker = 1 Active Deployment (중복 방지)
- 1 Equipment = 1 Active Deployment
- Deployment 시작일 검증
- PostgreSQL CHECK 제약 조건 또는 트리거 구현

### 5. 통계 및 리포트 강화 (우선순위: 낮음)

**예상 시간**: 3일

**작업 내용**:
- 출근율 차트 (일별/주별/월별)
- 작업 구역별 출근 통계
- 늦은 출근/조퇴 분석
- Recharts 라이브러리 사용
- PDF 리포트 생성

---

## 기술 노트

### 1. Google Maps API 키 관리

**환경 변수**:
```
VITE_GOOGLE_MAPS_API_KEY=AIza...
```

**주의사항**:
- API 키 제한 설정 (도메인 화이트리스트)
- 사용량 모니터링 (월 $200 무료 크레딧)
- Maps JavaScript API 활성화 필요

### 2. GPS 정확도

**영향 요인**:
- 실외 > 실내 (건물 내부는 정확도 낮음)
- WiFi 보정 사용 (enableHighAccuracy: true)
- 기기별 차이 (iPhone > Android 일반적으로 더 정확)

**개선 방법**:
- GPS + WiFi + 셀타워 삼각측량
- 여러 번 측정 후 평균값 사용
- Kalman Filter 적용 (고급)

### 3. Haversine 공식 vs Vincenty 공식

**Haversine**:
- 빠름 (삼각 함수 계산)
- 정확도: ±0.5%
- 단거리 (<100km)에 적합

**Vincenty**:
- 느림 (반복 계산)
- 정확도: ±0.005%
- 장거리에 적합

**결정**: 작업 구역은 반경 1km 이내이므로 Haversine 사용

### 4. 타임존 이슈

**문제**:
- 서버 UTC, 클라이언트 KST (UTC+9)
- 날짜 비교 시 타임존 차이로 오늘/어제 판정 오류

**해결**:
```typescript
// 오늘 00:00:00 KST
const today = new Date();
today.setHours(0, 0, 0, 0);

// 내일 00:00:00 KST
const tomorrow = new Date(today);
tomorrow.setDate(tomorrow.getDate() + 1);

// 오늘 출근 기록 조회
WHERE check_in_time >= today.toISOString()
  AND check_in_time < tomorrow.toISOString()
```

### 5. Base64 인코딩 vs Binary 전송

**엑셀 다운로드 선택**: Base64

**장점**:
- JSON 응답에 포함 가능
- 추가 HTTP 요청 불필요
- 간단한 구현

**단점**:
- 파일 크기 33% 증가
- 인코딩/디코딩 CPU 사용

**대안** (대용량 파일):
- S3 Presigned URL
- Streaming 다운로드

### 6. 성능 최적화

**현재 구현**:
- 출근 기록 목록: 제한 없이 전체 조회 (잠재적 문제)

**개선 필요**:
```typescript
// 페이지네이션
trpc.checkIn.list.useInfiniteQuery({
  limit: 50,
  cursor: lastCheckInId
})

// 또는 Offset 기반
trpc.checkIn.list.useQuery({
  limit: 50,
  offset: page * 50
})
```

**인덱스 확인**:
```sql
EXPLAIN ANALYZE
SELECT * FROM check_ins
WHERE user_id = '...'
ORDER BY check_in_time DESC;
```

### 7. 보안 고려사항

**GPS Spoofing 방지**:
- 완벽한 방지는 불가능
- 서버 측 거리 검증 (클라이언트 신뢰 X)
- 이상 패턴 감지 (예: 1분 내 100km 이동)
- IP 주소 기록 (VPN 사용 감지)

**데이터 보호**:
- GPS 좌표는 개인정보 (GDPR/개인정보보호법)
- 일정 기간 후 삭제 또는 익명화
- 접근 권한 엄격히 제한

---

## 성공 메트릭

### 기능 완성도
- ✅ 작업 구역 관리: 100%
- ✅ 출근 체크 API: 100%
- ✅ Worker 모바일 UI: 100%
- ✅ 관리자 대시보드: 100%
- ✅ Worker 정보 JOIN: 100%
- ✅ 엑셀 다운로드: 100%
- ⏳ WebAuthn 구현: 20% (스텁만)

### 코드 품질
- TypeScript 컴파일: ✅ 성공 (신규 코드)
- 기존 코드 타입 에러: ⚠️ 100+ (pre-existing)
- 테스트 커버리지: 0% (테스트 코드 미작성)

### 문서화
- ✅ 테스트 체크리스트: 100개+ 항목
- ✅ 작업 일지: 완전한 기록
- ✅ API 문서: 주석 및 타입 정의
- ⏳ 사용자 매뉴얼: 미작성

---

## 팀 협업

### Git 커밋 메시지 (제안)

```
feat: GPS 기반 출근 체크 시스템 구현

- 작업 구역 관리 (Google Maps 통합)
- 출근 체크 API (Haversine GPS 거리 계산)
- Worker 모바일 출근 UI
- 관리자 출근 현황 대시보드
- 엑셀 다운로드 기능 (xlsx)
- WebAuthn 기본 구조 (향후 생체 인증)

Related: #GPS-CHECKIN
```

### 다음 작업자를 위한 가이드

1. **테스트 체크리스트 참고**: `docs/check-in-system-test-checklist.md`
2. **작업 구역부터 설정**: `/work-zones`에서 최소 1개 생성
3. **Worker로 테스트**: `/mobile/login` PIN 1234
4. **문제 발생 시**:
   - 서버 로그 확인 (`console.log` 많이 추가됨)
   - 브라우저 Network 탭 확인
   - GPS 권한 확인

---

## 결론

GPS 기반 출근 체크 시스템의 핵심 기능을 성공적으로 구현했습니다.

**핵심 성과**:
- ✅ 직관적인 Google Maps UI
- ✅ 정확한 GPS 거리 계산 (Haversine)
- ✅ 유연한 정책 (구역 외 출근 허용)
- ✅ 실시간 모니터링 대시보드
- ✅ 데이터 분석 (엑셀 다운로드)
- ✅ 향후 확장성 (WebAuthn 준비)

**다음 우선순위**:
1. WebAuthn 생체 인증 구현 (지문/얼굴 인식)
2. 데이터 정합성 강화
3. 통합 테스트 및 버그 수정

**예상 완료일**: 2025-11-15 (1주일 추가 작업)

---

**작성자**: Claude Code Assistant
**검토자**: (사용자 이름)
**승인일**: (날짜)
