import {
  boolean,
  datetime,
  int,
  json,
  mysqlEnum,
  mysqlTable,
  text,
  timestamp,
  varchar,
} from "drizzle-orm/mysql-core";

/**
 * 건설현장 장비·인력 통합관리 시스템 데이터베이스 스키마
 * 
 * 주요 테이블:
 * - 사용자 및 권한: users
 * - 마스터 데이터: equipTypes, workerTypes, typeDocs, workerDocs, checklistForms
 * - 운영 데이터: equipment, workers, docsCompliance, checkRecords, workJournal
 */

// ============================================================
// 사용자 및 권한 관리
// ============================================================

export const users = mysqlTable("users", {
  id: varchar("id", { length: 64 }).primaryKey(),
  name: text("name"),
  email: varchar("email", { length: 320 }),
  loginMethod: varchar("loginMethod", { length: 64 }),
  role: mysqlEnum("role", ["admin", "owner", "bp", "ep", "worker", "inspector"])
    .default("owner")
    .notNull(),
  companyId: varchar("companyId", { length: 64 }),
  createdAt: timestamp("createdAt").defaultNow(),
  lastSignedIn: timestamp("lastSignedIn").defaultNow(),
});

export type User = typeof users.$inferSelect;
export type InsertUser = typeof users.$inferInsert;

// ============================================================
// 마스터 데이터: 장비 종류 및 관련 서류
// ============================================================

/**
 * 장비 종류 정의 (예: 크레인, 펌프카, 굴삭기 등)
 */
export const equipTypes = mysqlTable("equip_types", {
  id: varchar("id", { length: 64 }).primaryKey(),
  name: varchar("name", { length: 100 }).notNull().unique(),
  description: text("description"),
  checklistFormId: varchar("checklistFormId", { length: 64 }),
  createdAt: timestamp("createdAt").defaultNow(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow(),
});

export type EquipType = typeof equipTypes.$inferSelect;
export type InsertEquipType = typeof equipTypes.$inferInsert;

/**
 * 장비별 필수 서류 정의
 */
export const typeDocs = mysqlTable("type_docs", {
  id: varchar("id", { length: 64 }).primaryKey(),
  equipTypeId: varchar("equipTypeId", { length: 64 }).notNull(),
  docName: varchar("docName", { length: 200 }).notNull(),
  isMandatory: boolean("isMandatory").default(true).notNull(),
  hasExpiry: boolean("hasExpiry").default(false).notNull(),
  createdAt: timestamp("createdAt").defaultNow(),
});

export type TypeDoc = typeof typeDocs.$inferSelect;
export type InsertTypeDoc = typeof typeDocs.$inferInsert;

// ============================================================
// 마스터 데이터: 인력 유형 및 관련 서류
// ============================================================

/**
 * 인력 유형 정의 (예: 크레인 운전자, 용접공 등)
 */
export const workerTypes = mysqlTable("worker_types", {
  id: varchar("id", { length: 64 }).primaryKey(),
  name: varchar("name", { length: 100 }).notNull().unique(),
  description: text("description"),
  createdAt: timestamp("createdAt").defaultNow(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow(),
});

export type WorkerType = typeof workerTypes.$inferSelect;
export type InsertWorkerType = typeof workerTypes.$inferInsert;

/**
 * 인력별 필수 서류 정의
 */
export const workerDocs = mysqlTable("worker_docs", {
  id: varchar("id", { length: 64 }).primaryKey(),
  workerTypeId: varchar("workerTypeId", { length: 64 }).notNull(),
  docName: varchar("docName", { length: 200 }).notNull(),
  isMandatory: boolean("isMandatory").default(true).notNull(),
  hasExpiry: boolean("hasExpiry").default(false).notNull(),
  createdAt: timestamp("createdAt").defaultNow(),
});

export type WorkerDoc = typeof workerDocs.$inferSelect;
export type InsertWorkerDoc = typeof workerDocs.$inferInsert;

// ============================================================
// 마스터 데이터: 안전점검표 템플릿
// ============================================================

/**
 * 안전점검표 템플릿 (JSON 형식으로 동적 양식 관리)
 */
export const checklistForms = mysqlTable("checklist_forms", {
  id: varchar("id", { length: 64 }).primaryKey(),
  name: varchar("name", { length: 200 }).notNull(),
  formJson: json("formJson").notNull(),
  createdBy: varchar("createdBy", { length: 64 }),
  createdAt: timestamp("createdAt").defaultNow(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow(),
});

export type ChecklistForm = typeof checklistForms.$inferSelect;
export type InsertChecklistForm = typeof checklistForms.$inferInsert;

// ============================================================
// 운영 데이터: 등록된 장비
// ============================================================

/**
 * 등록된 장비 정보
 */
export const equipment = mysqlTable("equipment", {
  id: varchar("id", { length: 64 }).primaryKey(),
  equipTypeId: varchar("equipTypeId", { length: 64 }).notNull(),
  regNum: varchar("regNum", { length: 100 }).notNull().unique(),
  ownerId: varchar("ownerId", { length: 64 }),
  currentBpId: varchar("currentBpId", { length: 64 }),
  status: varchar("status", { length: 50 }).default("idle").notNull(),
  createdAt: timestamp("createdAt").defaultNow(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow(),
});

export type Equipment = typeof equipment.$inferSelect;
export type InsertEquipment = typeof equipment.$inferInsert;

// ============================================================
// 운영 데이터: 등록된 인력
// ============================================================

/**
 * 등록된 인력 정보
 */
export const workers = mysqlTable("workers", {
  id: varchar("id", { length: 64 }).primaryKey(),
  workerTypeId: varchar("workerTypeId", { length: 64 }).notNull(),
  name: varchar("name", { length: 100 }).notNull(),
  licenseNum: varchar("licenseNum", { length: 100 }),
  licenseStatus: varchar("licenseStatus", { length: 50 }),
  ownerId: varchar("ownerId", { length: 64 }),
  createdAt: timestamp("createdAt").defaultNow(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow(),
});

export type Worker = typeof workers.$inferSelect;
export type InsertWorker = typeof workers.$inferInsert;

// ============================================================
// 운영 데이터: 서류 관리
// ============================================================

/**
 * 업로드된 서류 관리 (장비 또는 인력)
 */
export const docsCompliance = mysqlTable("docs_compliance", {
  id: varchar("id", { length: 64 }).primaryKey(),
  targetType: mysqlEnum("targetType", ["equipment", "worker"]).notNull(),
  targetId: varchar("targetId", { length: 64 }).notNull(),
  docTypeId: varchar("docTypeId", { length: 64 }).notNull(),
  docType: varchar("docType", { length: 200 }).notNull(),
  fileName: varchar("fileName", { length: 300 }),
  fileUrl: varchar("fileUrl", { length: 500 }).notNull(),
  fileSize: int("fileSize"),
  mimeType: varchar("mimeType", { length: 100 }),
  issueDate: datetime("issueDate"),
  expiryDate: datetime("expiryDate"),
  
  // 승인 워크플로우
  workflowStage: varchar("workflowStage", { length: 50 }).default("bp_upload").notNull(),
  adminApprovedAt: timestamp("adminApprovedAt"),
  adminApprovedBy: varchar("adminApprovedBy", { length: 64 }),
  bpApprovedAt: timestamp("bpApprovedAt"),
  bpApprovedBy: varchar("bpApprovedBy", { length: 64 }),
  epApprovedAt: timestamp("epApprovedAt"),
  epApprovedBy: varchar("epApprovedBy", { length: 64 }),
  
  // 작업지시서
  workOrderFileUrl: varchar("workOrderFileUrl", { length: 500 }),
  workOrderUploadedAt: timestamp("workOrderUploadedAt"),
  
  status: varchar("status", { length: 50 }).default("pending_admin").notNull(),
  rejectReason: text("rejectReason"),
  uploadedBy: varchar("uploadedBy", { length: 64 }),
  uploadedAt: timestamp("uploadedAt").defaultNow(),
  updatedAt: timestamp("updatedAt").defaultNow().onUpdateNow(),
});

export type DocsCompliance = typeof docsCompliance.$inferSelect;
export type InsertDocsCompliance = typeof docsCompliance.$inferInsert;

// ============================================================
// 운영 데이터: 안전점검 기록
// ============================================================

/**
 * 실제 안전점검 결과 저장
 */
export const checkRecords = mysqlTable("check_records", {
  id: varchar("id", { length: 64 }).primaryKey(),
  equipmentId: varchar("equipmentId", { length: 64 }).notNull(),
  checklistFormId: varchar("checklistFormId", { length: 64 }).notNull(),
  inspectorId: varchar("inspectorId", { length: 64 }),
  inspectionDate: timestamp("inspectionDate").notNull(),
  resultJson: json("resultJson").notNull(),
  status: varchar("status", { length: 50 }).default("completed").notNull(),
  createdAt: timestamp("createdAt").defaultNow(),
});

export type CheckRecord = typeof checkRecords.$inferSelect;
export type InsertCheckRecord = typeof checkRecords.$inferInsert;

// ============================================================
// 운영 데이터: 일일 작업 확인서
// ============================================================

/**
 * 일일 작업 확인서
 */
export const workJournal = mysqlTable("work_journal", {
  id: varchar("id", { length: 64 }).primaryKey(),
  equipmentId: varchar("equipmentId", { length: 64 }).notNull(),
  workerId: varchar("workerId", { length: 64 }).notNull(),
  siteName: varchar("siteName", { length: 200 }).notNull(),
  workDate: datetime("workDate").notNull(),
  startTime: varchar("startTime", { length: 10 }).notNull(),
  endTime: varchar("endTime", { length: 10 }).notNull(),
  totalHours: int("totalHours").notNull(),
  workDetails: text("workDetails"),
  submittedBy: varchar("submittedBy", { length: 64 }),
  submittedAt: timestamp("submittedAt").defaultNow(),
  approvedByBp: varchar("approvedByBp", { length: 64 }),
  approvedAtBp: timestamp("approvedAtBp"),
  status: varchar("status", { length: 50 }).default("pending").notNull(),
  bpComments: text("bpComments"),
});

export type WorkJournal = typeof workJournal.$inferSelect;
export type InsertWorkJournal = typeof workJournal.$inferInsert;


// ============================================================
// 반입 요청 및 승인 워크플로우
// ============================================================

/**
 * 반입 요청 (BP → Owner → BP → EP)
 * 1. BP: 장비+인력 투입 요청
 * 2. Owner: 서류 첨부 및 승인
 * 3. BP: 작업계획서 첨부 및 승인
 * 4. EP: 최종 승인 → 반입 완료
 */
export const entryRequests = mysqlTable("entry_requests", {
  id: varchar("id", { length: 64 }).primaryKey(),
  requestNumber: varchar("requestNumber", { length: 100 }).notNull(), // 요청 번호
  
  // 요청 정보
  bpCompanyId: varchar("bpCompanyId", { length: 64 }).notNull(), // 협력사 ID
  bpUserId: varchar("bpUserId", { length: 64 }).notNull(), // 요청자 ID
  equipmentId: varchar("equipmentId", { length: 64 }).notNull(), // 장비 ID
  workerId: varchar("workerId", { length: 64 }).notNull(), // 운전자 ID
  
  purpose: text("purpose"), // 투입 목적
  requestedStartDate: datetime("requestedStartDate"), // 투입 예정일
  requestedEndDate: datetime("requestedEndDate"), // 철수 예정일
  
  // 워크플로우 상태
  status: mysqlEnum("status", [
    "bp_requested",      // 1단계: BP 요청
    "owner_reviewing",   // 2단계: Owner 검토중
    "owner_approved",    // 2단계: Owner 승인 (서류 첨부 완료)
    "bp_reviewing",      // 3단계: BP 검토중
    "bp_approved",       // 3단계: BP 승인 (작업계획서 첨부 완료)
    "ep_reviewing",      // 4단계: EP 검토중
    "ep_approved",       // 4단계: EP 최종 승인 (반입 완료)
    "rejected"           // 반려
  ]).default("bp_requested").notNull(),
  
  // Owner 승인 (2단계)
  ownerApprovedAt: datetime("ownerApprovedAt"),
  ownerApprovedBy: varchar("ownerApprovedBy", { length: 64 }),
  ownerComment: text("ownerComment"),
  
  // BP 승인 (3단계)
  bpApprovedAt: datetime("bpApprovedAt"),
  bpApprovedBy: varchar("bpApprovedBy", { length: 64 }),
  workPlanFileUrl: varchar("workPlanFileUrl", { length: 500 }), // 작업계획서
  bpComment: text("bpComment"),
  
  // EP 승인 (4단계)
  epApprovedAt: datetime("epApprovedAt"),
  epApprovedBy: varchar("epApprovedBy", { length: 64 }),
  epComment: text("epComment"),
  
  // 반려
  rejectedAt: datetime("rejectedAt"),
  rejectedBy: varchar("rejectedBy", { length: 64 }),
  rejectReason: text("rejectReason"),
  
  createdAt: timestamp("createdAt").defaultNow(),
  updatedAt: timestamp("updatedAt").defaultNow(),
});

export type EntryRequest = typeof entryRequests.$inferSelect;
export type InsertEntryRequest = typeof entryRequests.$inferInsert;

